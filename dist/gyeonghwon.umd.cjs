(function(k,E){typeof exports=="object"&&typeof module<"u"?module.exports=E():typeof define=="function"&&define.amd?define(E):(k=typeof globalThis<"u"?globalThis:k||self,k.gyeonghwon=E())})(this,function(){"use strict";var se=Object.defineProperty;var oe=(k,E,S)=>E in k?se(k,E,{enumerable:!0,configurable:!0,writable:!0,value:S}):k[E]=S;var p=(k,E,S)=>oe(k,typeof E!="symbol"?E+"":E,S);class k extends Event{constructor(e,t){super("render");p(this,"now");p(this,"tag");this.now=e,this.tag=t}}class E extends EventTarget{constructor(e=""){super();p(this,"width",0);p(this,"height",0);p(this,"numPlays",0);p(this,"playTime",0);p(this,"frames",[]);p(this,"tag");p(this,"nextRenderTime",0);p(this,"fNum",0);p(this,"prevF");p(this,"played",!1);p(this,"finished",!1);p(this,"contexts",[]);p(this,"tick");this.tag=e;const t=this,i=l=>{const d=t.fNum++%t.frames.length,u=t.frames[d];if(!(t.numPlays===0||t.fNum/t.frames.length<=t.numPlays)){t.played=!1,t.finished=!0;return}d===0&&(t.contexts.forEach(function(f){f.clearRect(0,0,t.width,t.height)}),t.prevF=void 0,u.disposeOp===2&&(u.disposeOp=1)),t.prevF&&t.prevF.disposeOp===1?t.contexts.forEach(function(f){f.clearRect(t.prevF.left,t.prevF.top,t.prevF.width,t.prevF.height)}):t.prevF&&t.prevF.disposeOp===2&&t.contexts.forEach(function(f){f.putImageData(t.prevF.iData,t.prevF.left,t.prevF.top)}),t.prevF=u,t.prevF.iData=null,t.prevF.disposeOp===2&&(t.prevF.iData=t.contexts[0].getImageData(u.left,u.top,u.width,u.height)),u.blendOp===0&&t.contexts.forEach(function(f){f.clearRect(u.left,u.top,u.width,u.height)}),t.contexts.forEach(function(f){f.drawImage(u.img,u.left,u.top)});const g=new k(l,this.tag);for(t.dispatchEvent(g),t.nextRenderTime===0&&(t.nextRenderTime=l);l>t.nextRenderTime+t.playTime;)t.nextRenderTime+=t.playTime;t.nextRenderTime+=u.delay};this.tick=l=>{for(;t.played&&t.nextRenderTime<=l;)i(l);t.played&&requestAnimationFrame(t.tick)}}setTag(e){this.tag=e}play(){this.played||this.finished||(this.rewind(),this.played=!0,requestAnimationFrame(this.tick))}rewind(){this.nextRenderTime=0,this.fNum=0,this.prevF=void 0,this.played=!1,this.finished=!1}addContext(e){if(this.contexts.length>0){const t=this.contexts[0].getImageData(0,0,this.width,this.height);e.putImageData(t,0,0)}this.contexts.push(e),e._aimg_animation=this}removeContext(e){const t=this.contexts.indexOf(e);t!==-1&&(this.contexts.splice(t,1),this.contexts.length===0&&this.rewind(),"_aimg_animation"in e&&delete e._aimg_animation)}removeAllContexts(){this.contexts.forEach(e=>{this.removeContext(e)})}latestContext(){return this.contexts[this.contexts.length-1]}isPlayed(){return this.played}isFinished(){return this.finished}}const S=new Uint8Array([137,80,78,71,13,10,26,10]),C=new Uint8Array([71,73,70,56,55,97]),O=new Uint8Array([71,73,70,56,57,97]),N=new Uint8Array([82,73,70,70,0,0,0,0,87,69,66,80]),D=function(n){let r;return function(e){return r||(r=new Promise(n)),e&&r.then(e),r}}(function(n){const r=document.createElement("canvas"),e={TypedArrays:"ArrayBuffer"in global,BlobURLs:"URL"in global,requestAnimationFrame:"requestAnimationFrame"in global,pageProtocol:location.protocol=="http:"||location.protocol=="https:",canvas:"getContext"in document.createElement("canvas"),APNG:!1};if(e.canvas){const t=new Image;t.onload=function(){const i=r.getContext("2d");i.drawImage(t,0,0),e.APNG=i.getImageData(0,0,1,1).data[3]===0,n(e)},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg=="}else n(e)}),$=function(n=!1){return D().then(function(r){if(!(r.APNG&&!n)){let e=!0;for(let t in r)r.hasOwnProperty(t)&&t!="APNG"&&(e=e&&r[t])}})};function M(n){const r=new Uint8Array(n);for(let e=0;e<S.length;e++)if(S[e]!==r[e])return!1;return!0}function Y(n){const r=new Uint8Array(n);for(let e=0;e<C.length;e++)if(C[e]!==r[e]&&O[e]!==r[e])return!1;return!0}function W(n){const r=new Uint8Array(n);for(let e=0;e<N.length;e++)if(N[e]!==r[e]&&N[e]!==0)return!1;return!0}const x={checkNativeFeatures:D,ifNeeded:$,pngCheck:M,gifCheck:Y,webpCheck:W,PNG_SIGNATURE_BYTES:S,GIF87_SIGNATURE_BYTES:C,GIF89_SIGNATURE_BYTES:O,WEBP_CHECK_BYTES:N},H=new Uint32Array(256);for(let n=0;n<256;n++){let r=n;for(let e=0;e<8;e++)r=r&1?3988292384^r>>>1:r>>>1;H[n]=r}function X(n,r,e){r=r||0,e=e||n.length-r;let t=-1;for(let i=r,l=r+e;i<l;i++)t=t>>>8^H[(t^n[i])&255];return t^-1}function R(n,r,e=!1){return e?n:r-1-n}function B(n,r,e=!1){let t=0;t+=n[r+R(0,4,e)]<<24>>>0;for(let i=1;i<4;i++)t+=n[r+R(i,4,e)]<<(3-i)*8;return t}function T(n,r,e=!1){let t=0;for(let i=0;i<2;i++)t+=n[r+R(i,2,e)]<<(1-i)*8;return t}function v(n,r,e=!1){let t=0;t+=n[r+R(0,3,e)]<<16>>>0;for(let i=1;i<3;i++)t+=n[r+R(i,3,e)]<<(2-i)*8;return t}function U(n,r){return n[r]}function L(n,r,e){const t=new Uint8Array(e);return t.set(n.subarray(r,r+e)),t}function F(n,r,e){const t=Array.prototype.slice.call(n.subarray(r,r+e));return String.fromCharCode.apply(String,t)}function b(n,r=!1){const e=[n&255,n>>>8&255,n>>>16&255,n>>>24&255];return r?e.reverse():e}function V(n,r=!1){const e=[n&255,n>>>8&255];return r?e.reverse():e}function j(n,r=!1){const e=[n&255,n>>>8&255,n>>>16&255];return r?e.reverse():e}function ee(n){const r=[];for(let e=0;e<n.length;e++)r.push(n.charCodeAt(e));return r}function G(n){return n.reduce((r,e)=>r*2+(e?1:0),0)}function I(n){const r=[];for(let e=7;e>=0;e--)r.push(!!(n&1<<e));return r}async function te(n,r={ignoreSingle:!1,forceLoop:!1}){const e=!!r.ignoreSingle,t=!!r.forceLoop,i=new Uint8Array(n);return new Promise((l,d)=>{let u=!1;if(q(i,(c,o,h,w)=>c==="acTL"?(u=!0,!1):!0),!u&&e){d("Not an animated PNG");return}const g=[],f=[],s=new E;let P,a;if(q(i,function(c,o,h,w){switch(c){case"IHDR":P=o.subarray(h+8,h+8+w),s.width=B(o,h+8,!0),s.height=B(o,h+12,!0);break;case"acTL":s.numPlays=B(o,h+8+4,!0);break;case"fcTL":a&&s.frames.push(a),a={},a.width=B(o,h+8+4,!0),a.height=B(o,h+8+8,!0),a.left=B(o,h+8+12,!0),a.top=B(o,h+8+16,!0);const ie=T(o,h+8+20,!0);let _=T(o,h+8+22,!0);_==0&&(_=100),a.delay=1e3*ie/_,a.delay<=10&&(a.delay=100),s.playTime+=a.delay,a.disposeOp=U(o,h+8+24),a.blendOp=U(o,h+8+25),a.dataParts=[];break;case"fdAT":a&&a.dataParts.push(o.subarray(h+8+4,h+8+w));break;case"IDAT":a?a.dataParts.push(o.subarray(h+8,h+8+w)):(a={},a.width=s.width,a.height=s.height,a.left=0,a.top=0,a.delay=100,s.playTime+=a.delay,a.disposeOp=1,a.blendOp=1,a.dataParts=[o.subarray(h+8,h+8+w)]);break;case"IEND":f.push(L(o,h,12+w));break;default:g.push(L(o,h,12+w))}return!0}),a&&s.frames.push(a),s.frames.length<=1)if(e){d("Not an animated PNG");return}else s.numPlays=1;else t&&(s.numPlays=0);let m=0;const A=new Blob(g),y=new Blob(f);for(let c=0;c<s.frames.length;c++){a=s.frames[c];let o=[];o.push(x.PNG_SIGNATURE_BYTES),P.set(b(a.width,!0),0),P.set(b(a.height,!0),4),o.push(z("IHDR",P)),o.push(A);for(let w=0;w<a.dataParts.length;w++)o.push(z("IDAT",a.dataParts[w]));o.push(y);const h=URL.createObjectURL(new Blob(o,{type:"image/png"}));delete a.dataParts,o=[],a.img=document.createElement("img"),a.img.onload=function(){URL.revokeObjectURL(this.src),m++,m===s.frames.length&&l(s)},a.img.onerror=function(){d("Image creation error")},a.img.src=h}})}function q(n,r){let e=8,t,i=!0;do{const l=B(n,e,!0);t=F(n,e+4,4),i=r(t,n,e,l),e+=12+l}while(i&&t!="IEND"&&e<n.length)}function z(n,r){const e=n.length+r.length,t=new Uint8Array(new ArrayBuffer(e+8));t.set(b(r.length,!0),0),t.set(ee(n),4),t.set(r,8);const i=X(t,4,e);return t.set(b(i,!0),e+4),t}async function ne(n,r={ignoreSingle:!1,forceLoop:!1}){const e=!!r.ignoreSingle,t=!!r.forceLoop,i=new Uint8Array(n);return new Promise((l,d)=>{let u=!1,g=0;if(J(i,(y,c,o,h)=>y==="APP"?(u=!0,!1):(y==="GCE"&&g++,!0)),!u&&g<2&&e){d("Not an animated GIF");return}const f=[],s=new E;let P,a;if(g>1&&(s.numPlays=1),J(i,(y,c,o,h)=>{switch(y){case"HDR":P=c.subarray(o,o+h),s.width=T(c,o),s.height=T(c,o+2);break;case"APP":F(c,o+3,11)==="NETSCAPE2.0"&&(s.numPlays=T(c,o+16));break;case"GCE":a&&s.frames.push(a),a={},a.delay=T(c,o+4)*10,a.delay<=10&&(a.delay=100),s.playTime+=a.delay,a.gce=L(c,o,h);break;case"IMG":a&&a.data&&(s.frames.push(a),a={}),a.width=T(c,o+5),a.height=T(c,o+7),a.left=T(c,o+1),a.top=T(c,o+3),a.data=L(c,o,h),a.disposeOp=0,a.blendOp=0;break;case"COM":break;case"PTE":break;case"EOF":f.push(L(c,o,h));break}return!0}),a&&s.frames.push(a),s.frames.length<=1)if(e){d("Not an animated PNG");return}else s.numPlays=1;else t&&(s.numPlays=0);let m=0;const A=new Blob(f);for(let y=0;y<s.frames.length;y++){a=s.frames[y];let c=[];c.push(x.GIF89_SIGNATURE_BYTES),P.set(V(a.width),0),P.set(V(a.height),2),c.push(P),c.push(a.gce),c.push(a.data),c.push(A);const o=URL.createObjectURL(new Blob(c,{type:"image/gif"}));delete a.data,delete a.gce,c=[],a.img=document.createElement("img"),a.img.onload=function(){URL.revokeObjectURL(this.src),m++,m===s.frames.length&&l(s)},a.img.onerror=function(){d("Image creation error")},a.img.src=o}})}function K(n,r){let e=0;for(;;){const t=U(n,r+e);if(e++,t===0)break;e+=t}return e}function J(n,r){let e=6,t=!0,i=0,l;do{if(e===6){l="HDR",i=7;const d=I(U(n,e+4)),u=d[0],g=G(d.splice(5,3));i+=u?Math.pow(2,g+1)*3:0}else{const d=F(n,e,1);switch(d){case"!":switch(U(n,e+1)){case 249:l="GCE";break;case 254:l="COM";break;case 1:l="PTE";break;case 255:l="APP";break;default:throw new Error("Unknown block")}i=2,i+=K(n,e+i);break;case",":l="IMG",i=10;const u=I(U(n,e+9)),g=u[0],f=G(u.splice(5,3));i+=(g?Math.pow(2,f+1)*3:0)+1,i+=K(n,e+i);break;case";":l="EOF";break;default:throw new Error(`Unknown block ${d}`)}}t=r(l,n,e,i),e+=i}while(t&&l!=="EOF"&&e<n.length)}async function re(n,r={ignoreSingle:!1,forceLoop:!1}){const e=!!r.ignoreSingle,t=!!r.forceLoop,i=new Uint8Array(n);return new Promise((l,d)=>{let u=!1;if(Q(i,(a,m,A,y)=>a==="ANIM"?(u=!0,!1):!0),!u&&e){d("Not an animated WebP");return}const g=new E;let f,s;if(Q(i,(a,m,A,y)=>{switch(a){case"VP8X":f=m.subarray(A,A+y),g.width=v(m,A+8+4)+1,g.height=v(m,A+8+4+3)+1;break;case"ANIM":g.numPlays=T(m,A+8+4);break;case"ANMF":s&&g.frames.push(s);let c=v(m,A+8+12);c<=10&&(c=100);const o=I(U(m,A+8+15));s={delay:c,width:v(m,A+8+6)+1,height:v(m,A+8+9)+1,left:v(m,A+8)*2,top:v(m,A+8+3)*2,disposeOp:o[7]?1:0,blendOp:o[6]?0:1,data:L(m,A+8+16,y-8-16)},g.playTime+=s.delay;break}return!0}),s&&g.frames.push(s),g.frames.length<=1)if(e){d("Not an animated WebP");return}else g.numPlays=1;else t&&(g.numPlays=0);let P=0;for(let a=0;a<g.frames.length;a++){s=g.frames[a];let m=[];const A=b(4+f.byteLength+s.data.byteLength),y=x.WEBP_CHECK_BYTES.map((h,w)=>w>3&&w<8?A[w-4]:x.WEBP_CHECK_BYTES[w]);m.push(y);const c=I(U(f,8));c[4]=!1,c[5]=!1,c[6]=!1,f.set([G(c)],8),f.set(j(s.width-1),12),f.set(j(s.height-1),15),m.push(f),m.push(s.data);const o=URL.createObjectURL(new Blob(m,{type:"image/webp"}));delete s.data,m=[],s.img=document.createElement("img"),s.img.onload=function(){URL.revokeObjectURL(this.src),P++,P===g.frames.length&&l(g)},s.img.onerror=function(){d("Image creation error")},s.img.src=o}})}function Q(n,r,e=12,t){const i=n.length;let l=!0;do{const d=F(n,e,4);let u=B(n,e+4);u%2&&u++,l=r(d,n,e,u+8),e+=u+8}while(l&&e<i)}async function ae(n){try{const r=await fetch(n,{method:"GET"});if(r.status!==200){const e=new Error(`HTTP error! status: ${r.status}`);throw e.status=r.status,e.url=n,e}return r.arrayBuffer()}catch(r){const e=r;throw e.url=n,e}}class Z extends EventTarget{constructor(e={}){super();p(this,"url2promise",{});p(this,"waitingBuffers",{});p(this,"waitingMilliSec");p(this,"forceLoop");p(this,"ignoreSingle");this.waitingMilliSec=e.waitingMilliSec||10,this.forceLoop=e.forceLoop||!1,this.ignoreSingle=e.ignoreSingle||!1}async parseURL(e){if(e in this.waitingBuffers){const t=this.waitingBuffers[e];return await new Promise(i=>setTimeout(i,this.waitingMilliSec)),this.parseBuffer(t.buffer,{ignoreSingle:t.ignoreSingle,forceLoop:t.forceLoop})}return e in this.url2promise||(this.url2promise[e]=ae(e).then(t=>this.parseBuffer(t))),this.url2promise[e]}async parseBuffer(e,t={}){const i=new Uint8Array(e),l="ignoreSingle"in t?t.ignoreSingle:this.ignoreSingle,d="forceLoop"in t?t.forceLoop:this.forceLoop;if(i.length>=3&&Y(e))return ne(e,{ignoreSingle:l,forceLoop:d});if(i.length>=4&&M(e))return te(e,{ignoreSingle:l,forceLoop:d});if(i.length>=12&&W(e))return re(e,{ignoreSingle:l,forceLoop:d});throw new Error("Unknown image format")}async animateImage(e){e.setAttribute("data-is-aimg","progress");try{const t=await this.parseURL(e.src);t.tag||t.setTag(e.src),e.setAttribute("data-is-aimg","yes");const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const l=i.getContext("2d");if(!l)throw new Error("Failed to get 2d context");return t.addContext(l),t.play(),t}catch(t){throw e.setAttribute("data-is-aimg","no"),t}}}return globalThis.Gyeonghwon=Z,Z});
